---
title: "HER2_Amp_Patients"
author: "Aurora S Blucher"
date: "3/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
```

## R Markdown

Script for TCGA patients; HER2

Notes 03/04/21
-TCGA breast patients, HER2 by IHC subset
-pull in TCGA clinical/survival data (using clinical data resource*)
-pull in CN and expression
-compare between the 2 groups

```{r}
#tcga patients
#clinical, get all BRCA patients
TCGASamplesAll<-read_excel(here("data", "TCGA_PANCAN_fromXena", "TCGA-CDR-SupplementalTableS1.xlsx"))
#View(TCGASamplesAll)

BRCASamples_Clinical<-TCGASamplesAll %>%
  filter(type=="BRCA")%>%
  select(Sample_ID = bcr_patient_barcode, type, histological_type, OS, OS.time)
#View(BRCASamples_Clinical) #1097 total

#TCGA COPY NUMBER info
#erbb2, subset to brca
#then require 2 or 1 (amplified)
#
TCGA_GISTIC<-read_tsv(here("data", "TCGA_PANCAN_fromXena", "TCGA.PANCAN.sampleMap_Gistic2_CopyNumber_Gistic2_all_thresholded.by_genes"))
head(TCGA_GISTIC)

TCGA_ERBB2<-TCGA_GISTIC %>%
  filter(Sample=="ERBB2")%>% # a little funny because we need genes but this first column is titled 'Sample'
  pivot_longer(-Sample, names_to = "Sample_ID", values_to = "GISTIC_Score") %>%
  mutate(Sample_ID_Abbr = str_sub(Sample_ID, 0, -4L)) %>%
  select(Sample_ID_Full=Sample_ID, Sample_ID=Sample_ID_Abbr, GeneName = Sample, GISTIC_Score)  
View(TCGA_ERBB2)
#output to file
write_tsv(TCGA_ERBB2, here("data_intermediate", "TCGA_PanCan_fromXena_GISTIC2_ERBB2.tsv"))

#okay now join with our TCGA BRCA subset above
BRCASamples_Clinical_joinERBB2<-left_join(BRCASamples_Clinical, TCGA_ERBB2)
View(BRCASamples_Clinical_joinERBB2)
#output to file
write_tsv(BRCASamples_Clinical_joinERBB2, here("data_intermediate", "TCGA_PanCan_fromXena_BRCA_ERBB2.tsv"))

#now let's look at the distribution of survival times here
#long tail out to right, Samuel wants to use 3 years as our cutoff
hist_survival<-BRCASamples_Clinical_joinERBB2 %>%
  filter(GISTIC_Score==2) %>%
  ggplot(aes(x=OS.time))+
  geom_histogram(color = "black", fill = "gray75")+
  geom_vline(aes(xintercept=1095),
            color="blue", linetype="dashed", size=1)+
  annotate(geom="text", x=1650, y=25, label="3YR Survival",
              color="blue")+
  labs(title="Distribution of OS in TCGA BRCA, ERBB2 Amplified Patients", subtitle="Requiring GISTIC Score==2")+
  xlab("Overall Survival (days)")+
  ylab("Count")
hist_survival

HER2AmpSamples<-BRCASamples_Clinical_joinERBB2 %>%
  filter(GISTIC_Score==2)
View(HER2AmpSamples)#133 total, write to file
write_tsv(HER2AmpSamples, here("data_intermediate", "TCGA_PanCan_fromXena_BRCA_ERBB2_Amplified.tsv"))

#Under 3 years
HER2Amp_Under3Years<-BRCASamples_Clinical_joinERBB2 %>%
  filter(GISTIC_Score==2) %>%
  filter(OS.time<1095)
View(HER2Amp_Under3Years) #79 samples

#At or over 3 years
HER2Amp_Over3Years<-BRCASamples_Clinical_joinERBB2 %>%
  filter(GISTIC_Score==2) %>%
  filter(OS.time>=1095)
View(HER2Amp_Over3Years) #54 samples

```

```{r}
#okay get all the gistic data for these 133 samples
head(TCGA_GISTIC)
TCGA_GISTIC_HER2Amp_Samples<-TCGA_GISTIC %>%
  select(Sample, one_of(HER2AmpSamples$Sample_ID_Full)) #not working?
View(TCGA_GISTIC_HER2Amp_Samples)
#write to file
write_tsv(TCGA_GISTIC_HER2Amp_Samples, here("data_intermediate", "TCGA_PanCan_fromXena_GISTIC_HER2AmpSamples.tsv"))

#we only want genes where there are 2 calls
#don't need to subset, just count up


#then group each gene
#count samples SHORT
#count samples LONG







```

